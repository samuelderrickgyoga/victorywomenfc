{% extends 'base.html' %}
{% block content %}
<div class="gallery-container">
    <h1 class="text-4xl font-bold mb-6 text-center">Gallery</h1>
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
        {% for item in items %}
        <div class="gallery-item bg-white p-4 rounded-lg shadow-lg">
            {% if item.image %}
            <img src="{{ item.image.url }}" alt="Gallery Item" class="w-full h-48 object-cover mb-4">
            {% endif %}
            {% if item.video %}
            <video src="{{ item.video.url }}" controls class="w-full h-48 mb-4"></video>
            {% endif %}
            <p>{{ item.description }}</p>
            
            <!-- Like Section -->
            <div class="like-section mt-4">
                <form class="like-form" data-item-id="{{ item.id }}">
                    <input type="email" name="email" placeholder="Enter your Gmail" class="border p-2 w-full rounded mb-2">
                    <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-500 transition">Like</button>
                    <span class="likes-count">{{ item.likes }} Likes</span>
                </form>
            </div>

            <!-- Comment Section -->
            <div class="comment-section mt-4">
                <form class="comment-form" data-item-id="{{ item.id }}">
                    <input type="email" name="email" placeholder="Enter your Gmail" class="border p-2 w-full rounded mb-2">
                    <textarea name="comment" placeholder="Add a comment" class="border p-2 w-full rounded h-16"></textarea>
                    <button type="submit" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-500 transition">Comment</button>
                </form>

                <!-- Comments Display -->
                <div class="comments-list mt-4">
                    {% for comment in item.comments.all %}
                    <div class="comment mb-2">
                        <p><strong>{{ comment.gmail }}:</strong> {{ comment.text }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Like Form Submission via AJAX
    document.querySelectorAll('.like-form').forEach(form => {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const itemId = this.dataset.itemId;
            const emailInput = this.querySelector('input[name="email"]').value;

            fetch(`/gallery/${itemId}/like/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: new URLSearchParams({ email: emailInput })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    this.querySelector('.likes-count').textContent = `${data.likes} Likes`;
                }
            });
        });
    });

    // Comment Form Submission via AJAX
    document.querySelectorAll('.comment-form').forEach(form => {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const itemId = this.dataset.itemId;
            const emailInput = this.querySelector('input[name="email"]').value;
            const commentText = this.querySelector('textarea[name="comment"]').value;

            fetch(`/gallery/${itemId}/comment/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: new URLSearchParams({ email: emailInput, comment: commentText })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    const commentList = this.closest('.comment-section').querySelector('.comments-list');
                    commentList.insertAdjacentHTML('beforeend', `<div class="comment mb-2"><p><strong>${data.comment.gmail}:</strong> ${data.comment.text}</p></div>`);
                }
            });
        });
    });
});
</script>
{% endblock %}
